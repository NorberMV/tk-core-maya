



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tank.platform.bundle &mdash; tk-core v0.20.13 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          
    <a href='http://developer.shotgridsoftware.com'>
    
        <img style='width: 191px;
                height: 60px;
                margin: 2px;
                border-radius: 0px;
                padding: 0px;'
            src='../../../_static/logo@2x.png'/>
    
    </a>
    

          
            <a href="../../../index.html" class="icon icon-home"> tk-core
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../initializing.html">Initialization and startup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core.html">Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platform.html">Apps, Engines and Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../descriptor.html">Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../environment_variables.html">Environment Variables</a></li>
</ul>

            
          

    <a href='genindex.html'>Alphabetic Index</a>

    <div style='margin-top: 50px;
                margin-left: 10px;
                margin-right: 10px;
                padding: 10px;
                color: #b3b3b3;
                font-size: 70%;
                border-radius: 3px;
                background-color: #444;
                line-height: 18px;
                '>
    <style>
        a.custom_post_menu { display: inline;
                             padding: 0px;
                             text-decoration: underline; }
    </style>

    <b>tk-core</b> v0.20.13.<br>
    
        This documentation is part of the ShotGrid Pipeline Toolkit.
    
    For more information, please visit
    <a class=custom_post_menu href='https://developer.shotgridsoftware.com'>The ShotGrid developer portal.</a>.
    The code associated with this documentation can be found
    <a class=custom_post_menu href='https://github.com/shotgunsoftware/tk-core'>here</a>.

    </div>



        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">tk-core</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>tank.platform.bundle</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tank.platform.bundle</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2013 Shotgun Software Inc.</span>
<span class="c1">#</span>
<span class="c1"># CONFIDENTIAL AND PROPRIETARY</span>
<span class="c1">#</span>
<span class="c1"># This work is provided &quot;AS IS&quot; and subject to the Shotgun Pipeline Toolkit</span>
<span class="c1"># Source Code License included in this distribution package. See LICENSE.</span>
<span class="c1"># By accessing, using, copying or modifying this work you indicate your</span>
<span class="c1"># agreement to the Shotgun Pipeline Toolkit Source Code License. All rights</span>
<span class="c1"># not expressly granted therein are reserved by Shotgun Software Inc.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Base class for Abstract classes for Engines, Apps and Frameworks</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">hook</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">sgre</span> <span class="k">as</span> <span class="n">re</span>
<span class="kn">from</span> <span class="nn">..util.metrics</span> <span class="kn">import</span> <span class="n">EventMetric</span>
<span class="kn">from</span> <span class="nn">..log</span> <span class="kn">import</span> <span class="n">LogManager</span>
<span class="kn">from</span> <span class="nn">..errors</span> <span class="kn">import</span> <span class="n">TankError</span><span class="p">,</span> <span class="n">TankNoDefaultValueError</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="kn">import</span> <span class="n">TankContextChangeNotSupportedError</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">.import_stack</span> <span class="kn">import</span> <span class="n">ImportStack</span>
<span class="kn">from</span> <span class="nn">tank_vendor</span> <span class="kn">import</span> <span class="n">six</span>

<span class="n">core_logger</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TankBundle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract Base class for any engine, framework app etc in tank</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tk</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor.</span>

<span class="sd">        :param tk: :class:`~sgtk.Sgtk` instance</span>
<span class="sd">        :param context: A context object to define the context on disk where the engine is operating</span>
<span class="sd">        :type context: :class:`~sgtk.Context`</span>
<span class="sd">        :param settings: dictionary of settings to associate with this object</span>
<span class="sd">        :param descriptor: Descriptor pointing at associated code.</span>
<span class="sd">        :param env: An Environment object to associate with this bundle.</span>
<span class="sd">        :param log: A python logger to associate with this bundle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tk</span> <span class="o">=</span> <span class="n">tk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache_location</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__module_uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span> <span class="o">=</span> <span class="n">descriptor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__frameworks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__environment</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span> <span class="o">=</span> <span class="n">log</span>

        <span class="c1"># emit an engine started event</span>
        <span class="n">tk</span><span class="o">.</span><span class="n">execute_core_hook</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">TANK_BUNDLE_INIT_HOOK_NAME</span><span class="p">,</span> <span class="n">bundle</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1">##########################################################################################</span>
    <span class="c1"># internal API</span>

    <span class="k">def</span> <span class="nf">log_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">log_version</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_once</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">command_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log metrics for this bundle and the given action.</span>

<span class="sd">        :param str action: Action string to log, e.g. &#39;Opened Workfile&#39;.</span>
<span class="sd">        :param log_version: Deprecated and ignored, but kept for backward compatibility.</span>
<span class="sd">        :param bool log_once: ``True`` if this metric should be ignored if it</span>
<span class="sd">            has already been logged. Defaults to ``False``.</span>
<span class="sd">        :param str command_name: A Toolkit command name to add to the metric properties.</span>

<span class="sd">        Internal Use Only - We provide no guarantees that this method</span>
<span class="sd">        will be backwards compatible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">command_name</span><span class="p">:</span>
            <span class="n">properties</span><span class="p">[</span><span class="n">EventMetric</span><span class="o">.</span><span class="n">KEY_COMMAND</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_name</span>

        <span class="n">EventMetric</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">EventMetric</span><span class="o">.</span><span class="n">GROUP_TOOLKIT</span><span class="p">,</span>
            <span class="n">action</span><span class="p">,</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
            <span class="n">log_once</span><span class="o">=</span><span class="n">log_once</span><span class="p">,</span>
            <span class="n">bundle</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1">##########################################################################################</span>
    <span class="c1"># properties used by internal classes, not part of the public interface</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method - not part of Tank&#39;s public interface.</span>
<span class="sd">        This method may be changed or even removed at some point in the future.</span>
<span class="sd">        We leave no guarantees that it will remain unchanged over time, so</span>
<span class="sd">        do not use in any app code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method - not part of Tank&#39;s public interface.</span>
<span class="sd">        This method may be changed or even removed at some point in the future.</span>
<span class="sd">        We leave no guarantees that it will remain unchanged over time, so</span>
<span class="sd">        do not use in any app code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings</span>

    <span class="c1">##########################################################################################</span>
    <span class="c1"># methods used by internal classes, not part of the public interface</span>

    <span class="k">def</span> <span class="nf">get_setting_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method - not part of Tank&#39;s public interface.</span>

<span class="sd">        Get a value from the settings dictionary passed in</span>
<span class="sd">        using the logic from this application</span>

<span class="sd">        :param other_settings: dictionary to use to find setting</span>
<span class="sd">        :param key: setting name</span>
<span class="sd">        :param default: default value to return</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_setting_value</span><span class="p">(</span><span class="n">other_settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_template_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_settings</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method - not part of Tank&#39;s public interface.</span>

<span class="sd">        A shortcut for looking up which template is referenced in the given setting from</span>
<span class="sd">        the settings dictionary passed in.  It then calls get_template_by_name() on it.</span>

<span class="sd">        :param other_settings: dictionary to use to find setting</span>
<span class="sd">        :param key: setting name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setting_from</span><span class="p">(</span><span class="n">other_settings</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_by_name</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>

    <span class="c1">##########################################################################################</span>
    <span class="c1"># properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The short name for the item (e.g. tk-maya)</span>

<span class="sd">        :returns: name as string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span><span class="o">.</span><span class="n">system_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The display name for the item (e.g. Maya Engine)</span>

<span class="sd">        :returns: display name as string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span><span class="o">.</span><span class="n">display_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A short description of the item</span>

<span class="sd">        :returns: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span><span class="o">.</span><span class="n">description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The version of the item (e.g. &#39;v0.2.3&#39;)</span>

<span class="sd">        :returns: string representing the version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span><span class="o">.</span><span class="n">version</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">icon_256</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Path to a 256x256 pixel png file which describes the item</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span><span class="o">.</span><span class="n">icon_256</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">style_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary of style constants. These can be used to build</span>
<span class="sd">        UIs using standard colors and other style components. All keys returned</span>
<span class="sd">        in this dictionary can also be used inside a style.qss that lives</span>
<span class="sd">        at the root level of the app, engine or framework. Use a</span>
<span class="sd">        ``{{DOUBLE_BACKET}}`` syntax in the stylesheet file, for example::</span>

<span class="sd">            QWidget</span>
<span class="sd">            {</span>
<span class="sd">                color: {{SG_FOREGROUND_COLOR}};</span>
<span class="sd">            }</span>

<span class="sd">        This property returns the values for all constants, for example::</span>

<span class="sd">            {</span>
<span class="sd">              &quot;SG_HIGHLIGHT_COLOR&quot;: &quot;#18A7E3&quot;,</span>
<span class="sd">              &quot;SG_ALERT_COLOR&quot;: &quot;#FC6246&quot;,</span>
<span class="sd">              &quot;SG_FOREGROUND_COLOR&quot;: &quot;#C8C8C8&quot;</span>
<span class="sd">            }</span>

<span class="sd">        :returns: Dictionary. See above for example</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">constants</span><span class="o">.</span><span class="n">SG_STYLESHEET_CONSTANTS</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">documentation_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the relevant documentation url for this item.</span>

<span class="sd">        :returns: url string, None if no documentation was found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span><span class="o">.</span><span class="n">documentation_url</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">support_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the relevant support url for this item.</span>

<span class="sd">        :returns: url string, None if no documentation was found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span><span class="o">.</span><span class="n">support_url</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">disk_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The folder on disk where this item is located.</span>
<span class="sd">        This can be useful if you want to write app code</span>
<span class="sd">        to retrieve a local resource::</span>

<span class="sd">            app_font = os.path.join(self.disk_location, &quot;resources&quot;, &quot;font.fnt&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># note: the reason we don&#39;t call __file__ directly is because</span>
        <span class="c1">#       we don&#39;t want to return the location of the &#39;bundle.py&#39;</span>
        <span class="c1">#       base class but rather the location of object that</span>
        <span class="c1">#       has been derived from this class.</span>
        <span class="n">path_to_this_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path_to_this_file</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cache_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An item-specific location on disk where the app or engine can store</span>
<span class="sd">        random cache data. This location is guaranteed to exist on disk.</span>

<span class="sd">        This location is configurable via the ``cache_location`` hook.</span>
<span class="sd">        It typically points at a path in the local filesystem, e.g on a mac::</span>

<span class="sd">            ~/Library/Caches/Shotgun/SITENAME/PROJECT_ID/BUNDLE_NAME</span>

<span class="sd">        This can be used to store cache data that the app wants to reuse across</span>
<span class="sd">        sessions::</span>

<span class="sd">            stored_query_data_path = os.path.join(self.cache_location, &quot;query.dat&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk</span><span class="o">.</span><span class="n">pipeline_configuration</span><span class="o">.</span><span class="n">get_project_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_project_cache_location</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">site_cache_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A site location on disk where the app or engine can store</span>
<span class="sd">        random cache data. This location is guaranteed to exist on disk.</span>

<span class="sd">        This location is configurable via the ``cache_location`` hook.</span>
<span class="sd">        It typically points at a path in the local filesystem, e.g on a mac::</span>

<span class="sd">            ~/Library/Caches/Shotgun/SITENAME/BUNDLE_NAME</span>

<span class="sd">        This can be used to store cache data that the app wants to reuse across</span>
<span class="sd">        sessions and can be shared across a site::</span>

<span class="sd">            stored_query_data_path = os.path.join(self.site_cache_location, &quot;query.dat&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this method is memoized for performance since it is being called a lot!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cache_location</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;site&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__cache_location</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk</span><span class="o">.</span><span class="n">execute_core_hook_method</span><span class="p">(</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">CACHE_LOCATION_HOOK_NAME</span><span class="p">,</span>
                <span class="s2">&quot;get_bundle_data_cache_path&quot;</span><span class="p">,</span>
                <span class="n">project_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">plugin_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">pipeline_configuration_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">bundle</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cache_location</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The context associated with this item.</span>

<span class="sd">        :returns: :class:`~sgtk.Context`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__context</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context_change_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether a context change is allowed without the need for a restart.</span>
<span class="sd">        If a bundle supports on-the-fly context changing, this property should</span>
<span class="sd">        be overridden in the deriving class and forced to return True.</span>

<span class="sd">        :returns: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the Toolkit API instance associated with this item</span>

<span class="sd">        :returns: :class:`~sgtk.Tank`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk</span>

    <span class="c1"># new name compatibility</span>
    <span class="n">sgtk</span> <span class="o">=</span> <span class="n">tank</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">frameworks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of all frameworks associated with this item</span>

<span class="sd">        :returns: List of framework objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__frameworks</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Standard python :class:`~logging.Logger` for this engine, app or framework.</span>

<span class="sd">        Use this whenever you want to emit or process</span>
<span class="sd">        log messages. If you are developing an app,</span>
<span class="sd">        engine or framework, call this method for generic logging.</span>

<span class="sd">        .. note:: Inside the ``python`` area of your app, engine or framework,</span>
<span class="sd">                  we recommend that you use :meth:`sgtk.platform.get_logger`</span>
<span class="sd">                  for your logging.</span>

<span class="sd">        Logging will be dispatched to a logger parented under the</span>
<span class="sd">        main toolkit logging namespace::</span>

<span class="sd">            # pattern</span>
<span class="sd">            sgtk.env.environment_name.engine_instance_name</span>

<span class="sd">            # for example</span>
<span class="sd">            sgtk.env.asset.tk-maya</span>

<span class="sd">        .. note:: If you want all log messages that you are emitting in your</span>
<span class="sd">                  app, engine or framework to be written to a log file or</span>
<span class="sd">                  to a logging console, you can attach a std log handler here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__log</span>

    <span class="c1">##########################################################################################</span>
    <span class="c1"># public methods</span>

    <span class="k">def</span> <span class="nf">change_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method for context changing.</span>

<span class="sd">        Implemented by deriving classes that wish to support context changes and</span>
<span class="sd">        require specific logic to do so safely.</span>

<span class="sd">        :param new_context: The context being changed to.</span>
<span class="sd">        :type context: :class:`~sgtk.Context`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_change_allowed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;Bundle </span><span class="si">%r</span><span class="s2"> does not allow context changes.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">TankContextChangeNotSupportedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pre_context_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_context</span><span class="p">,</span> <span class="n">new_context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called before a context change.</span>

<span class="sd">        Implemented by deriving classes.</span>

<span class="sd">        :param old_context:     The context being changed away from.</span>
<span class="sd">        :type old_context: :class:`~sgtk.Context`</span>
<span class="sd">        :param new_context:     The context being changed to.</span>
<span class="sd">        :type new_context: :class:`~sgtk.Context`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">post_context_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_context</span><span class="p">,</span> <span class="n">new_context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called after a context change.</span>

<span class="sd">        Implemented by deriving classes.</span>

<span class="sd">        :param old_context:     The context being changed away from.</span>
<span class="sd">        :type old_context: :class:`~sgtk.Context`</span>
<span class="sd">        :param new_context:     The context being changed to.</span>
<span class="sd">        :type new_context: :class:`~sgtk.Context`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">import_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Special import command for Toolkit bundles. Imports the python folder inside</span>
<span class="sd">        an app and returns the specified module name that exists inside the python folder.</span>

<span class="sd">        Each Toolkit App or Engine can have a python folder which contains additional</span>
<span class="sd">        code. In order to ensure that Toolkit can run multiple versions of the same app,</span>
<span class="sd">        as well as being able to reload app code if it changes, it is recommended that</span>
<span class="sd">        this method is used whenever you want to access code in the python location.</span>

<span class="sd">        For example, imagine you had the following structure::</span>

<span class="sd">            tk-multi-mybundle</span>
<span class="sd">               |- app.py or engine.py or framework.py</span>
<span class="sd">               |- info.yml</span>
<span class="sd">               \- python</span>
<span class="sd">                   |- __init__.py   &lt;--- Needs to contain &#39;from . import tk_multi_mybundle&#39;</span>
<span class="sd">                   \- tk_multi_mybundle</span>

<span class="sd">        The above structure is a standard Toolkit app outline. ``app.py`` is a</span>
<span class="sd">        light weight wrapper and the python module</span>
<span class="sd">        ``tk_multi_myapp`` module contains the actual code payload.</span>
<span class="sd">        In order to import this in a Toolkit friendly way, you need to run</span>
<span class="sd">        the following when you want to load the payload module inside of app.py::</span>

<span class="sd">            module_obj = self.import_module(&quot;tk_multi_myapp&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># local import to avoid cycles</span>

        <span class="c1"># first, set the module we are currently processing</span>
        <span class="n">ImportStack</span><span class="o">.</span><span class="n">push_current_bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># get the python folder</span>
            <span class="n">python_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disk_location</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">BUNDLE_PYTHON_FOLDER</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">python_folder</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot import - folder </span><span class="si">%s</span><span class="s2"> does not exist!&quot;</span> <span class="o">%</span> <span class="n">python_folder</span>
                <span class="p">)</span>

            <span class="c1"># and import</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__module_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;Importing python modules in </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">python_folder</span><span class="p">)</span>
                <span class="c1"># alias the python folder with a UID to ensure it is unique every time it is imported</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__module_uid</span> <span class="o">=</span> <span class="s2">&quot;tkimp</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
                <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__module_uid</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">python_folder</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">imp</span><span class="o">.</span><span class="n">PKG_DIRECTORY</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># we can now find our actual module in sys.modules as GUID.module_name</span>
            <span class="n">mod_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__module_uid</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mod_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot find module </span><span class="si">%s</span><span class="s2"> as part of </span><span class="si">%s</span><span class="s2">!&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">python_folder</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># lastly, append our own object to the added module. This is to make it easier to</span>
            <span class="c1"># do elegant imports in the class scope via the tank.platform.import_framework method</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span><span class="o">.</span><span class="n">_tank_bundle</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># no longer processing this one</span>
            <span class="n">ImportStack</span><span class="o">.</span><span class="n">pop_current_bundle</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_project_cache_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the bundle&#39;s cache-location path for the given project id.</span>

<span class="sd">        :param project_id:  The project Entity id number.</span>
<span class="sd">        :type project_id:   int</span>

<span class="sd">        :returns:           Cache location directory path.</span>
<span class="sd">        :rtype str:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this method is memoized for performance since it is being called a lot!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cache_location</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__cache_location</span><span class="p">[</span><span class="n">project_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tk</span><span class="o">.</span><span class="n">execute_core_hook_method</span><span class="p">(</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">CACHE_LOCATION_HOOK_NAME</span><span class="p">,</span>
                <span class="s2">&quot;get_bundle_data_cache_path&quot;</span><span class="p">,</span>
                <span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
                <span class="n">plugin_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__tk</span><span class="o">.</span><span class="n">pipeline_configuration</span><span class="o">.</span><span class="n">get_plugin_id</span><span class="p">(),</span>
                <span class="n">pipeline_configuration_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__tk</span><span class="o">.</span><span class="n">pipeline_configuration</span><span class="o">.</span><span class="n">get_shotgun_id</span><span class="p">(),</span>
                <span class="n">bundle</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cache_location</span><span class="p">[</span><span class="n">project_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a value from the item&#39;s settings::</span>

<span class="sd">            &gt;&gt;&gt; app.get_setting(&#39;entity_types&#39;)</span>
<span class="sd">            [&#39;Sequence&#39;, &#39;Shot&#39;, &#39;Asset&#39;, &#39;Task&#39;]</span>

<span class="sd">        :param key: config name</span>
<span class="sd">        :param default: default value to return</span>
<span class="sd">        :returns: Value from the environment configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_setting_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a template object for a particular template setting in the Framework configuration.</span>
<span class="sd">        This method will look at the app configuration, determine which template is being referred to</span>
<span class="sd">        in the setting, go into the main platform Template API and fetch that particular template object.</span>

<span class="sd">        This is a convenience method. Shorthand for ``self.sgtk.templates[ self.get_setting(key) ]``.</span>

<span class="sd">        :param key: Setting to retrieve template for</span>
<span class="sd">        :returns: :class:`~Template` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_by_name</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_template_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note: This is for advanced use cases - Most of the time you should probably use</span>
<span class="sd">        :meth:`get_template()`. Find a particular template, the way it is named in the master</span>
<span class="sd">        config file ``templates.yml``. This method will access the master templates file</span>
<span class="sd">        directly and pull out a specifically named template without using the app config.</span>
<span class="sd">        Note that using this method may result in code which is less portable across</span>
<span class="sd">        studios, since it makes assumptions about how templates are named and defined in</span>
<span class="sd">        the master config. Generally speaking, it is often better to access templates using</span>
<span class="sd">        the app configuration and the get_template() method.</span>

<span class="sd">        This is a convenience method. Shorthand for ``self.sgtk.templates[template_name]``.</span>

<span class="sd">        :param template_name</span>
<span class="sd">        :returns: :class:`~Template` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">base_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a hook that is part of the environment configuration for the current bundle.</span>

<span class="sd">        Convenience method that calls :meth:`execute_hook_method()` with the</span>
<span class="sd">        method_name parameter set to &quot;execute&quot;.</span>

<span class="sd">        .. warning:: This method is present for backwards compatibility. For</span>
<span class="sd">                     all new hooks, we recommend using :meth:`execute_hook_method`</span>
<span class="sd">                     instead.</span>

<span class="sd">        You simply pass the name of the hook setting that you want to execute and</span>
<span class="sd">        the accompanying arguments, and toolkit will find the correct hook file based</span>
<span class="sd">        on the currently configured setting and then execute the execute() method for</span>
<span class="sd">        that hook.</span>

<span class="sd">        An optional ``base_class`` can be provided to override the default :class:`~sgtk.Hook`</span>
<span class="sd">        base class. This is useful for bundles that want to define and document a strict</span>
<span class="sd">        interface for hooks. The classes defined in the hook have to derived from this classes.</span>

<span class="sd">        .. note:: For more information about hooks, see :class:`~sgtk.Hook`</span>

<span class="sd">        :param key: The name of the hook setting you want to execute.</span>
<span class="sd">        :param base_class: A python class to use as the base class for the created</span>
<span class="sd">            hook. This will override the default hook base class, ``Hook``.</span>
<span class="sd">        :returns: The return value from the hook</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hook_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">resolved_hook_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_hook_expression</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">hook_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hook</span><span class="o">.</span><span class="n">execute_hook_method</span><span class="p">(</span>
            <span class="n">resolved_hook_paths</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">base_class</span><span class="o">=</span><span class="n">base_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_hook_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">base_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a specific method in a hook that is part of the</span>
<span class="sd">        environment configuration for the current bundle.</span>

<span class="sd">        You simply pass the name of the hook setting that you want to execute, the</span>
<span class="sd">        name of the method you want to execute and the accompanying arguments.</span>
<span class="sd">        Toolkit will find the correct hook file based on the currently configured</span>
<span class="sd">        setting and then execute the specified method.</span>

<span class="sd">        Hooks form a flexible way to extend and make toolkit apps or engines configurable.</span>
<span class="sd">        A hook acts like a setting in that it needs to be configured as part of the app&#39;s</span>
<span class="sd">        configuration, but instead of being a simple value, it is a code snippet contained</span>
<span class="sd">        inside a class.</span>

<span class="sd">        Apps typically provide default hooks to make installation and overriding easy.</span>
<span class="sd">        Each hook is represented by a setting, similar to the ones you access via</span>
<span class="sd">        the :meth:`get_setting()` method, however instead of retrieving a fixed value,</span>
<span class="sd">        you execute code which generates a value.</span>

<span class="sd">        This method will execute a specific method for a given hook setting. Toolkit will</span>
<span class="sd">        find the actual python hook file and handle initialization and execution for you,</span>
<span class="sd">        by looking at the configuration settings and resolve a path based on this.</span>

<span class="sd">        Arguments should always be passed in by name. This is to make it easy to add new</span>
<span class="sd">        parameters without breaking backwards compatibility, for example</span>
<span class="sd">        ``execute_hook_method(&quot;validator&quot;, &quot;pre_check&quot;, name=curr_scene, version=curr_ver).``</span>

<span class="sd">        An optional ``base_class`` can be provided to override the default :class:`~sgtk.Hook`</span>
<span class="sd">        base class. This is useful for bundles that want to define and document a strict</span>
<span class="sd">        interface for hooks. The classes defined in the hook have to derived from this classes.</span>

<span class="sd">        .. note:: For more information about hooks, see :class:`~sgtk.Hook`</span>

<span class="sd">        :param key: The name of the hook setting you want to execute.</span>
<span class="sd">        :param method_name: Name of the method to execute</span>
<span class="sd">        :param base_class: A python class to use as the base class for the created</span>
<span class="sd">            hook. This will override the default hook base class, ``Hook``.</span>
<span class="sd">        :returns: The return value from the hook</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hook_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">resolved_hook_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_hook_expression</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">hook_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hook</span><span class="o">.</span><span class="n">execute_hook_method</span><span class="p">(</span>
            <span class="n">resolved_hook_paths</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">base_class</span><span class="o">=</span><span class="n">base_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_hook_expression</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">base_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute an arbitrary hook via an expression. While the methods execute_hook</span>
<span class="sd">        and execute_hook_method allows you to execute a particular hook setting as</span>
<span class="sd">        specified in the app configuration manifest, this methods allows you to</span>
<span class="sd">        execute a hook directly by passing a hook expression, for example</span>
<span class="sd">        ``{config}/path/to/my_hook.py``</span>

<span class="sd">        This is useful if you are doing rapid app development and don&#39;t necessarily</span>
<span class="sd">        want to expose a hook as a configuration setting just yet. It is also useful</span>
<span class="sd">        if you have app settings that are nested deep inside of lists or dictionaries.</span>
<span class="sd">        In that case, you cannot use execute_hook, but instead will have to retrieve</span>
<span class="sd">        the value specifically and then run it.</span>

<span class="sd">        An optional ``base_class`` can be provided to override the default :class:`~sgtk.Hook`</span>
<span class="sd">        base class. This is useful for bundles that want to define and document a strict</span>
<span class="sd">        interface for hooks. The classes defined in the hook have to derived from this classes.</span>

<span class="sd">        .. note:: For more information about hooks, see :class:`~sgtk.Hook`</span>

<span class="sd">        :param hook_expression: Path to hook to execute. See above for syntax details.</span>
<span class="sd">        :param method_name: Method inside the hook to execute.</span>
<span class="sd">        :param base_class: A python class to use as the base class for the created</span>
<span class="sd">            hook. This will override the default hook base class, ``Hook``.</span>
<span class="sd">        :returns: The return value from the hook</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resolved_hook_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_hook_expression</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hook</span><span class="o">.</span><span class="n">execute_hook_method</span><span class="p">(</span>
            <span class="n">resolved_hook_paths</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">base_class</span><span class="o">=</span><span class="n">base_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_hook_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute an arbitrary hook located in the hooks folder for this project.</span>
<span class="sd">        The hook_name is the name of the python file in which the hook resides,</span>
<span class="sd">        without the file extension.</span>

<span class="sd">        In most use cases, the execute_hook method is the preferred way to</span>
<span class="sd">        access a hook from an app.</span>

<span class="sd">        .. warning:: Now deprecated - Please use :meth:`execute_hook_expression`</span>
<span class="sd">                  instead.</span>

<span class="sd">        This method is typically only used when you want to execute an arbitrary</span>
<span class="sd">        list of hooks, for example if you want to run a series of arbitrary</span>
<span class="sd">        user defined pre-publish validation hooks.</span>

<span class="sd">        .. note:: For more information about hooks, see :class:`~sgtk.Hook`</span>

<span class="sd">        :param hook_name: name of the legacy hook file to execute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hook_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="o">.</span><span class="n">pipeline_configuration</span><span class="o">.</span><span class="n">get_hooks_location</span><span class="p">()</span>
        <span class="n">hook_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hook_folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.py&quot;</span> <span class="o">%</span> <span class="n">hook_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hook</span><span class="o">.</span><span class="n">execute_hook</span><span class="p">(</span><span class="n">hook_path</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_hook_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">,</span> <span class="n">base_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the instance of a hook object given an expression.</span>

<span class="sd">        This is useful for complex workflows where it is beneficial to</span>
<span class="sd">        maintain a handle to a hook instance. Normally, hooks are stateless</span>
<span class="sd">        and every time a hook is called, a new instance is returned. This method</span>
<span class="sd">        provides a standardized way to retrieve an instance of a hook::</span>

<span class="sd">            self._plugin = app_object.create_hook_instance(&quot;{config}/path/to/my_hook.py&quot;)</span>
<span class="sd">            self._plugin.execute_method_x()</span>
<span class="sd">            self._plugin.execute_method_y()</span>
<span class="sd">            self._plugin.execute_method_z()</span>

<span class="sd">        The hook expression is the raw value that is specified in the configuration file.</span>
<span class="sd">        If you want to access a configuration setting instead (like how for example</span>
<span class="sd">        :meth:`execute_hook_method` works), simply call :meth:`get_setting()` to retrieve</span>
<span class="sd">        the value and then pass the settings value to this method.</span>

<span class="sd">        .. note:: For more information about hook syntax, see :class:`~sgtk.Hook`</span>

<span class="sd">        An optional ``base_class`` can be provided to override the default :class:`~sgtk.Hook`</span>
<span class="sd">        base class. This is useful for bundles that create hook instances at</span>
<span class="sd">        execution time and wish to provide default implementation without the need</span>
<span class="sd">        to configure the base hook. The supplied class must inherit from Hook.</span>

<span class="sd">        :param hook_expression: Path to hook to execute. See above for syntax details.</span>
<span class="sd">        :param base_class: A python class to use as the base class for the created</span>
<span class="sd">            hook. This will override the default hook base class, ``Hook``.</span>
<span class="sd">        :returns: :class:`Hook` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resolved_hook_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_hook_expression</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hook</span><span class="o">.</span><span class="n">create_hook_instance</span><span class="p">(</span>
            <span class="n">resolved_hook_paths</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">base_class</span><span class="o">=</span><span class="n">base_class</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">ensure_folder_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure that the given folder exists on disk.</span>
<span class="sd">        Convenience method to make it easy for apps and engines to create folders in a</span>
<span class="sd">        standardized fashion. While the creation of high level folder structure such as</span>
<span class="sd">        Shot and Asset folders is typically handled by the folder creation system in</span>
<span class="sd">        Toolkit, Apps tend to need to create leaf-level folders such as publish folders</span>
<span class="sd">        and work areas. These are often created just in time of the operation.</span>

<span class="sd">        .. note:: This method calls out to the ``ensure_folder_exists`` core hook, making</span>
<span class="sd">                  the I/O operation user configurable. We recommend using this method</span>
<span class="sd">                  over the methods provided in ``sgtk.util.filesystem``.</span>

<span class="sd">        :param path: path to create</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__tk</span><span class="o">.</span><span class="n">execute_core_hook</span><span class="p">(</span>
                <span class="s2">&quot;ensure_folder_exists&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">bundle_obj</span><span class="o">=</span><span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span><span class="s2">&quot;Error creating folder </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_metrics_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Should be re-implemented in deriving classes and return a dictionary with</span>
<span class="sd">        the properties needed to log a metric event for this bundle.</span>

<span class="sd">        :raises: NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1">##########################################################################################</span>
    <span class="c1"># internal helpers</span>

    <span class="k">def</span> <span class="nf">_set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the current context associated with this item.</span>

<span class="sd">        :param new_context: The new context to associate with the bundle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__context</span> <span class="o">=</span> <span class="n">new_context</span>

    <span class="k">def</span> <span class="nf">_set_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the bundle&#39;s internal settings dictionary.</span>

<span class="sd">        :param settings:    The new settings dict to store.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings</span> <span class="o">=</span> <span class="n">settings</span>

    <span class="k">def</span> <span class="nf">__resolve_hook_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_name</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolves a hook settings path into an absolute path.</span>

<span class="sd">        :param settings_name: The name of the hook setting in the configuration. If the</span>
<span class="sd">                              hook expression passed in to this method is not directly</span>
<span class="sd">                              associated with a configuration setting, for example if it</span>
<span class="sd">                              comes from a nested settings structure and is resolved via</span>
<span class="sd">                              execute_hook_by_name, this parameter will be None.</span>

<span class="sd">        :param hook_expression: The hook expression value that should be resolved.</span>

<span class="sd">        :returns: A full path to a hook file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">hook_expression</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> config setting </span><span class="si">%s</span><span class="s2">: Configuration value cannot be None!&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># make sure to replace the `{engine_name}` token if it exists.</span>
        <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">TANK_HOOK_ENGINE_REFERENCE_TOKEN</span> <span class="ow">in</span> <span class="n">hook_expression</span><span class="p">:</span>
            <span class="n">engine_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_engine_name</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">engine_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span>
                    <span class="s2">&quot;No engine could be determined for hook expression &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span>
                    <span class="s2">&quot;The hook could not be resolved.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hook_expression</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hook_expression</span> <span class="o">=</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="n">constants</span><span class="o">.</span><span class="n">TANK_HOOK_ENGINE_REFERENCE_TOKEN</span><span class="p">,</span> <span class="n">engine_name</span>
                <span class="p">)</span>

        <span class="c1"># first the legacy, old-style hooks case</span>
        <span class="k">if</span> <span class="n">hook_expression</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TANK_BUNDLE_DEFAULT_HOOK_SETTING</span><span class="p">:</span>
            <span class="c1"># hook settings points to the default one.</span>
            <span class="c1"># find the name of the hook from the manifest</span>

            <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span><span class="o">.</span><span class="n">configuration_schema</span>
            <span class="n">engine_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_engine_name</span><span class="p">()</span>

            <span class="c1"># Entries are on the following form</span>
            <span class="c1">#</span>
            <span class="c1"># hook_publish_file:</span>
            <span class="c1">#    type: hook</span>
            <span class="c1">#    description: Called when a file is published, e.g. copied from a work area to a publish area.</span>
            <span class="c1">#    default_value: maya_publish_file</span>
            <span class="c1">#</span>
            <span class="n">resolved_hook_name</span> <span class="o">=</span> <span class="n">resolve_default_value</span><span class="p">(</span>
                <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">settings_name</span><span class="p">),</span> <span class="n">engine_name</span><span class="o">=</span><span class="n">engine_name</span>
            <span class="p">)</span>

            <span class="c1"># get the full path for the resolved hook name:</span>
            <span class="k">if</span> <span class="n">resolved_hook_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{self}</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="c1"># new format hook:</span>
                <span class="c1">#  default_value: &#39;{self}/my_hook.py&#39;</span>
                <span class="n">hooks_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disk_location</span><span class="p">,</span> <span class="s2">&quot;hooks&quot;</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">resolved_hook_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{self}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">hooks_folder</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># old style hook:</span>
                <span class="c1">#  default_value: &#39;my_hook&#39;</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disk_location</span><span class="p">,</span> <span class="s2">&quot;hooks&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.py&quot;</span> <span class="o">%</span> <span class="n">resolved_hook_name</span>
                <span class="p">)</span>

            <span class="c1"># if the hook uses the engine name then output a more useful error message if a hook for</span>
            <span class="c1"># the engine can&#39;t be found.</span>
            <span class="k">if</span> <span class="n">engine_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="c1"># produce user friendly error message</span>
                <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> config setting </span><span class="si">%s</span><span class="s2">: This hook is using an engine specific &quot;</span>
                    <span class="s2">&quot;hook setup (e.g &#39;</span><span class="si">%s</span><span class="s2">&#39;) but no hook &#39;</span><span class="si">%s</span><span class="s2">&#39; has been provided with the app. &quot;</span>
                    <span class="s2">&quot;In order for this app to work with engine </span><span class="si">%s</span><span class="s2">, you need to provide a &quot;</span>
                    <span class="s2">&quot;custom hook implementation. Please contact support for more &quot;</span>
                    <span class="s2">&quot;information&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_name</span><span class="p">,</span> <span class="n">resolved_hook_name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">engine_name</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{self}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="c1"># bundle local reference</span>
            <span class="n">hooks_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disk_location</span><span class="p">,</span> <span class="s2">&quot;hooks&quot;</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{self}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">hooks_folder</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{config}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="c1"># config hook</span>
            <span class="n">hooks_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="o">.</span><span class="n">pipeline_configuration</span><span class="o">.</span><span class="n">get_hooks_location</span><span class="p">()</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{config}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">hooks_folder</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{engine}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="c1"># look for the hook in the currently running engine</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> config setting </span><span class="si">%s</span><span class="s2">: Could not determine the current &quot;</span>
                    <span class="s2">&quot;engine. Unable to resolve hook path for: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_name</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">hooks_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">disk_location</span><span class="p">,</span> <span class="s2">&quot;hooks&quot;</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{engine}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">hooks_folder</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{$&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;}&quot;</span> <span class="ow">in</span> <span class="n">hook_expression</span><span class="p">:</span>
            <span class="c1"># environment variable: {$HOOK_PATH}/path/to/foo.py</span>
            <span class="n">env_var</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\{\$([^\}]+)\}&quot;</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">env_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> config setting </span><span class="si">%s</span><span class="s2">: This hook is referring to the configuration value &#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span>
                    <span class="s2">&quot;but no environment variable named &#39;</span><span class="si">%s</span><span class="s2">&#39; can be &quot;</span>
                    <span class="s2">&quot;found!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_name</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">,</span> <span class="n">env_var</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">env_var_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">env_var</span><span class="p">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{$</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">env_var</span><span class="p">,</span> <span class="n">env_var_value</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;}&quot;</span> <span class="ow">in</span> <span class="n">hook_expression</span><span class="p">:</span>
            <span class="c1"># bundle instance (e.g. &#39;{tk-framework-perforce_v1.x.x}/foo/bar.py&#39; )</span>
            <span class="c1"># first find the bundle instance</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\{([^\}]+)\}&quot;</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># for now, only look at framework instance names. Later on,</span>
            <span class="c1"># if the request ever comes up, we could consider extending</span>
            <span class="c1"># to supporting app instances etc. However we would need to</span>
            <span class="c1"># have some implicit rules for handling ambiguity since</span>
            <span class="c1"># there can be multiple items (engines, apps etc) potentially</span>
            <span class="c1"># having the same instance name.</span>
            <span class="n">fw_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__environment</span><span class="o">.</span><span class="n">get_frameworks</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">instance</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fw_instances</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> config setting </span><span class="si">%s</span><span class="s2">: This hook is referring to the configuration value &#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span>
                    <span class="s2">&quot;but no framework with instance name &#39;</span><span class="si">%s</span><span class="s2">&#39; can be found in the currently &quot;</span>
                    <span class="s2">&quot;running environment. The currently loaded frameworks &quot;</span>
                    <span class="s2">&quot;are </span><span class="si">%s</span><span class="s2">.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">settings_name</span><span class="p">,</span>
                        <span class="n">hook_expression</span><span class="p">,</span>
                        <span class="n">instance</span><span class="p">,</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fw_instances</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">fw_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__environment</span><span class="o">.</span><span class="n">get_framework_descriptor</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fw_desc</span><span class="o">.</span><span class="n">exists_local</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> config setting </span><span class="si">%s</span><span class="s2">: This hook is referring to the configuration value &#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span>
                    <span class="s2">&quot;but the framework with instance name &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist on disk. Please run &quot;</span>
                    <span class="s2">&quot;the tank cache_apps command.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_name</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># get path to framework on disk</span>
            <span class="n">hooks_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fw_desc</span><span class="o">.</span><span class="n">get_path</span><span class="p">(),</span> <span class="s2">&quot;hooks&quot;</span><span class="p">)</span>
            <span class="c1"># create the path to the file</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">,</span> <span class="n">hooks_folder</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># old school config hook name, e.g. just &#39;foo&#39;</span>
            <span class="n">hook_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="o">.</span><span class="n">pipeline_configuration</span><span class="o">.</span><span class="n">get_hooks_location</span><span class="p">()</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hook_folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.py&quot;</span> <span class="o">%</span> <span class="n">hook_expression</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">__resolve_hook_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_name</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method for resolving hook expressions. This method handles</span>
<span class="sd">        resolving an environment configuration value into a path on disk.</span>

<span class="sd">        There are two generations of hook formats - old-style and new-style.</span>

<span class="sd">        Old style formats:</span>

<span class="sd">        - hook_setting: foo     -- Resolves &#39;foo&#39; to CURRENT_PC/hooks/foo.py</span>
<span class="sd">        - hook_setting: default -- Resolves the value from the info.yml manifest and uses</span>
<span class="sd">          the default hook code supplied by the bundle.</span>

<span class="sd">        New style formats:</span>

<span class="sd">        - hook_setting: {$HOOK_PATH}/path/to/foo.py  -- environment variable.</span>
<span class="sd">        - hook_setting: {self}/path/to/foo.py   -- looks in the hooks folder in the local bundle</span>
<span class="sd">        - hook_setting: {config}/path/to/foo.py -- looks in the hooks folder in the config</span>
<span class="sd">        - hook_setting: {engine}/path/to/foo.py -- looks in the hooks folder of the current engine.</span>
<span class="sd">        - hook_setting: {tk-framework-perforce_v1.x.x}/path/to/foo.py -- looks in the hooks folder of a</span>
<span class="sd">          framework instance that exists in the current environment. Basically, each entry inside the</span>
<span class="sd">          frameworks section in the current environment can be specified here - all these entries are</span>
<span class="sd">          on the form frameworkname_versionpattern, for example tk-framework-widget_v0.1.2 or</span>
<span class="sd">          tk-framework-shotgunutils_v1.3.x.</span>

<span class="sd">        :param settings_name: If this hook is associated with a setting in the bundle, this is the</span>
<span class="sd">                              name of that setting. This is used to identify the inheritance relationships</span>
<span class="sd">                              between the hook expression that is evaluated and if this hook derives from</span>
<span class="sd">                              a hook inside an app.</span>
<span class="sd">        :param hook_expression: The path expression to a hook.</span>
<span class="sd">        :returns: List of paths to hooks files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># split up the config value into distinct items</span>
        <span class="n">unresolved_hook_paths</span> <span class="o">=</span> <span class="n">hook_expression</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

        <span class="c1"># first of all, see if we should add a base class hook to derive from:</span>
        <span class="c1">#</span>
        <span class="c1"># Basically, any overridden hook implicitly derives from the default hook.</span>
        <span class="c1"># specified in the manifest.</span>
        <span class="c1"># if the settings value is not {self} add this to the inheritance chain.</span>
        <span class="c1"># Examples:</span>
        <span class="c1">#</span>
        <span class="c1"># Manifest: {self}/foo_{engine_name}.py</span>
        <span class="c1"># In config: {config}/my_custom_hook.py</span>
        <span class="c1"># The my_custom_hook.py implicitly derives from the python class defined</span>
        <span class="c1"># in the manifest, so prepend it:</span>
        <span class="c1"># hook_paths: [&quot;{self}/foo_tk-maya.py&quot;, &quot;{config}/my_custom_hook.py&quot; ]</span>
        <span class="c1">#</span>
        <span class="c1"># Check only new-style hooks. All new style hooks start with a {</span>
        <span class="k">if</span> <span class="n">unresolved_hook_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">unresolved_hook_paths</span><span class="p">[</span>
            <span class="mi">0</span>
        <span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{self}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="c1"># this is a new style hook that is not the default hook value.</span>
            <span class="c1"># now prepend the default hook first in the list</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span><span class="o">.</span><span class="n">configuration_schema</span>

            <span class="n">default_value</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">settings_name</span><span class="p">:</span>
                <span class="n">default_value</span> <span class="o">=</span> <span class="n">resolve_default_value</span><span class="p">(</span>
                    <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">settings_name</span><span class="p">),</span> <span class="n">engine_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_engine_name</span><span class="p">()</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">default_value</span><span class="p">:</span>  <span class="c1"># possible not to have a default value!</span>

                <span class="c1"># expand the default value to be referenced from {self} and with the .py suffix</span>
                <span class="c1"># for backwards compatibility with the old syntax where the default value could</span>
                <span class="c1"># just be &#39;hook_name&#39; with implicit &#39;{self}&#39; and no suffix!</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">default_value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{self}</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="n">default_value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{self}</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.py&quot;</span> <span class="o">%</span> <span class="n">default_value</span>

                <span class="c1"># so now we have a path to a potential default hook inside the app or engine</span>
                <span class="c1"># There is however one possibility when there may not be a hook, and this is</span>
                <span class="c1"># when {engine_name} is defined as part of the default value, but no default hook</span>
                <span class="c1"># exists for the engine that we are currently running. In this case, we don&#39;t want</span>
                <span class="c1"># to wedge in this non-existing hook file into the inheritance chain because it does</span>
                <span class="c1"># not exist!</span>
                <span class="n">full_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_hook_path</span><span class="p">(</span><span class="n">settings_name</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
                    <span class="c1"># add to inheritance path</span>
                    <span class="n">unresolved_hook_paths</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span>

        <span class="c1"># resolve paths into actual file paths</span>
        <span class="n">resolved_hook_paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__resolve_hook_path</span><span class="p">(</span><span class="n">settings_name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unresolved_hook_paths</span>
        <span class="p">]</span>

        <span class="n">core_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Resolved hook expression (associated with setting &#39;</span><span class="si">%s</span><span class="s2">&#39;): &#39;</span><span class="si">%s</span><span class="s2">&#39; -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_name</span><span class="p">,</span> <span class="n">hook_expression</span><span class="p">,</span> <span class="n">resolved_hook_paths</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">resolved_hook_paths</span>

    <span class="k">def</span> <span class="nf">__resolve_setting_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve a setting value.  Exposed to allow values to be resolved for</span>
<span class="sd">        settings derived outside of the app.</span>

<span class="sd">        :param settings: the settings dictionary source</span>
<span class="sd">        :param key: setting name</span>
<span class="sd">        :param default: a default value to use for the setting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># An old use case exists whereby the key does not exist in the</span>
        <span class="c1"># config schema so we need to account for that.</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__descriptor</span><span class="o">.</span><span class="n">configuration_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resolve_setting_value</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__tk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_engine_name</span><span class="p">(),</span> <span class="n">schema</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_engine_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the bundle&#39;s engine name if available. None otherwise.</span>
<span class="sd">        Convenience method to avoid try/except everywhere.</span>

<span class="sd">        :return: The engine name or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># note - this technically violates the generic nature of the bundle</span>
        <span class="c1"># base class implementation because the engine member is not defined</span>
        <span class="c1"># in the bundle base class (only in App and Framework, not Engine) - an</span>
        <span class="c1"># engine trying to define a hook using the {engine_name} construct will</span>
        <span class="c1"># therefore get an error.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">name</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">engine_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">engine_name</span>


<span class="k">def</span> <span class="nf">_post_process_settings_r</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">bundle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursive post-processing of settings values</span>

<span class="sd">    :param tk: Toolkit API instance</span>
<span class="sd">    :param key: setting name</span>
<span class="sd">    :param value: Input value to resolve using specified schema</span>
<span class="sd">    :param schema: A schema defining types and defaults for settings.</span>
<span class="sd">    :param bundle: The bundle object. This is only used in the case</span>
<span class="sd">        the value argument is a string starting with &quot;hook:&quot;, which</span>
<span class="sd">        then requires the use of a core hook to resolve the setting.</span>

<span class="sd">    :returns: Processed value for key setting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">settings_type</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

    <span class="c1"># first check for procedural overrides where instead of getting a value,</span>
    <span class="c1"># directly from the config, we call a hook to evaluate a config value</span>
    <span class="c1"># at runtime:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;hook:&quot;</span><span class="p">):</span>
        <span class="c1"># handle the special form where the value is computed in a hook.</span>
        <span class="c1">#</span>
        <span class="c1"># if the template parameter is on the form</span>
        <span class="c1"># a) hook:foo_bar</span>
        <span class="c1"># b) hook:foo_bar:testing1:testing2</span>
        <span class="c1">#</span>
        <span class="c1"># The following hook will be called</span>
        <span class="c1"># a) core hook &#39;foo_bar&#39; with parameters []</span>
        <span class="c1"># b) core hook &#39;foo_bar&#39; with parameters [&#39;testing1&#39;, &#39;testing2&#39;]</span>
        <span class="c1">#</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">hook_name</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">processed_val</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">execute_core_hook</span><span class="p">(</span>
            <span class="n">hook_name</span><span class="p">,</span> <span class="n">setting</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">bundle_obj</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="n">extra_params</span><span class="o">=</span><span class="n">params</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">processed_val</span>

    <span class="c1"># No procedural overrides in place - instead handle the value based on type</span>
    <span class="k">if</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
        <span class="n">processed_val</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">value_schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">processed_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_post_process_settings_r</span><span class="p">(</span>
                    <span class="n">tk</span><span class="o">=</span><span class="n">tk</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">value_schema</span><span class="p">,</span> <span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># note - we assign the original values here because we</span>
        <span class="n">processed_val</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value_schema</span><span class="p">)</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">processed_val</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_post_process_settings_r</span><span class="p">(</span>
                <span class="n">tk</span><span class="o">=</span><span class="n">tk</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">schema</span><span class="o">=</span><span class="n">value_schema</span><span class="p">,</span> <span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span>
            <span class="p">)</span>

    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s2">&quot;config_path&quot;</span><span class="p">:</span>
        <span class="c1"># this is a config path. Stored on the form</span>
        <span class="c1"># foo/bar/baz.png, we should translate that into</span>
        <span class="c1"># PROJECT_PATH/tank/config/foo/bar/baz.png</span>
        <span class="n">config_folder</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">pipeline_configuration</span><span class="o">.</span><span class="n">get_config_location</span><span class="p">()</span>
        <span class="n">adjusted_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="n">processed_val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_folder</span><span class="p">,</span> <span class="n">adjusted_value</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># pass-through</span>
        <span class="n">processed_val</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">processed_val</span>


<span class="k">def</span> <span class="nf">resolve_setting_value</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span> <span class="n">engine_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">bundle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve a setting value.  Exposed to allow values to be resolved for</span>
<span class="sd">    settings derived outside of the app.</span>

<span class="sd">    :param tk: :class:`~sgtk.Sgtk` Toolkit API instance</span>
<span class="sd">    :param str engine_name: Name of Toolkit engine instance.</span>
<span class="sd">    :param dict schema: A schema defining types and defaults for settings.</span>
<span class="sd">                        The post processing code requires the schema to</span>
<span class="sd">                        introspect the settings&#39; types, defaults, etc.</span>
<span class="sd">    :param dict settings: the settings dictionary source</span>
<span class="sd">    :param str key: setting name</span>
<span class="sd">    :param default: a default value to use for the setting</span>
<span class="sd">    :param bundle: The bundle object. This is only used in situations where</span>
<span class="sd">        a setting&#39;s value must be resolved via calling a hook.</span>

<span class="sd">    :returns: Resolved value of input setting key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the value for the supplied key</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="c1"># Value provided by the settings</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">schema</span><span class="p">:</span>
        <span class="c1"># Resolve a default value from the schema. This checks various</span>
        <span class="c1"># legacy default value forms in the schema keys.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">resolve_default_value</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">engine_name</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Nothing in the settings, no schema, fallback to the supplied</span>
        <span class="c1"># default value</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>

    <span class="c1"># We have a value of some kind and a schema. Allow the post</span>
    <span class="c1"># processing code to further resolve the value.</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">schema</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">_post_process_settings_r</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">bundle</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">resolve_default_value</span><span class="p">(</span>
    <span class="n">schema</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raise_if_missing</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract a default value from the supplied schema.</span>

<span class="sd">    Fall back on the supplied default value if no default could be</span>
<span class="sd">    determined from the schema.</span>

<span class="sd">    :param schema: The schema for the setting default to resolve</span>
<span class="sd">    :param default: Optional fallback default value.</span>
<span class="sd">    :param engine_name: Optional name of the current engine if there is one.</span>
<span class="sd">    :param raise_if_missing: If True, raise TankNoDefaultValueError if no</span>
<span class="sd">        default value is found.</span>
<span class="sd">    :return: The resolved default value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_missing</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Engine-specific default value keys are allowed (ex:</span>
    <span class="c1"># &quot;default_value_tk-maya&quot;). If an engine name was supplied,</span>
    <span class="c1"># build the corresponding engine-specific default value key.</span>
    <span class="n">engine_default_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">engine_name</span><span class="p">:</span>
        <span class="n">engine_default_key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">constants</span><span class="o">.</span><span class="n">TANK_SCHEMA_DEFAULT_VALUE_KEY</span><span class="p">,</span>
            <span class="n">engine_name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Now look for a default value to use.</span>
    <span class="k">if</span> <span class="n">engine_default_key</span> <span class="ow">and</span> <span class="n">engine_default_key</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
        <span class="c1"># An engine specific key exists, use it.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="n">engine_default_key</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">constants</span><span class="o">.</span><span class="n">TANK_SCHEMA_DEFAULT_VALUE_KEY</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
        <span class="c1"># The standard default value key</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">TANK_SCHEMA_DEFAULT_VALUE_KEY</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No default value found, fall back on the supplied default.</span>
        <span class="n">default_missing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>

    <span class="c1"># ---- type specific checks</span>

    <span class="n">setting_type</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

    <span class="c1"># special case handling for list params - check if</span>
    <span class="c1"># allows_empty is True, in that case set default value to []</span>
    <span class="k">if</span> <span class="n">setting_type</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allows_empty&quot;</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># special case handling for dict params - check if</span>
    <span class="c1"># allows_empty is True, in that case set default value to {}</span>
    <span class="k">if</span> <span class="n">setting_type</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allows_empty&quot;</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># special case for template params. if allows_empty is True, then we allow</span>
    <span class="c1"># a value of None. make sure we don&#39;t raise in the &quot;raise_if_missing&quot; case.</span>
    <span class="k">if</span> <span class="n">setting_type</span> <span class="o">==</span> <span class="s2">&quot;template&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allows_empty&quot;</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">default_missing</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">setting_type</span> <span class="o">==</span> <span class="s2">&quot;hook&quot;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">_resolve_default_hook_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">engine_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">default_missing</span> <span class="ow">and</span> <span class="n">raise_if_missing</span><span class="p">:</span>
        <span class="c1"># calling code requested an exception if no default value exists.</span>
        <span class="c1"># the value may have been overridden by one of the special cases above,</span>
        <span class="c1"># so only raise if the value is None.</span>
        <span class="k">raise</span> <span class="n">TankNoDefaultValueError</span><span class="p">(</span><span class="s2">&quot;No default value found.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">_resolve_default_hook_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">engine_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a hook value, evaluate any special keys or legacy values.</span>

<span class="sd">    :param value: The unresolved default value for the hook</span>
<span class="sd">    :param engine_name: The name of the engine for engine-specific hook values</span>
<span class="sd">    :return: The resolved hook default value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="c1"># Replace the engine reference token if it exists and there is an engine.</span>
    <span class="c1"># In some instances, such as during engine startup, as apps are being</span>
    <span class="c1"># validated, the engine instance name may not be available. This might be ok</span>
    <span class="c1"># since hooks are actually evaluated just before they are executed. We&#39;ll</span>
    <span class="c1"># simply return the value with the engine name token intact.</span>
    <span class="k">if</span> <span class="n">engine_name</span> <span class="ow">and</span> <span class="n">constants</span><span class="o">.</span><span class="n">TANK_HOOK_ENGINE_REFERENCE_TOKEN</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">TANK_HOOK_ENGINE_REFERENCE_TOKEN</span><span class="p">,</span> <span class="n">engine_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">):</span>
        <span class="c1"># This is an old-style hook. In order to maintain backward</span>
        <span class="c1">#  compatibility, return the value in the new style.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{self}</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.py&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>

    <span class="c1"># the remaining tokens ({self}, {config}, {tk-framework-...}) will be</span>
    <span class="c1"># resolved at runtime just before the hook is executed.</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, Autodesk

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2114792-1', 'auto');
  ga('send', 'pageview');
</script>



</body>
</html>